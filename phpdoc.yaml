title: browsecat - parcours de catalogues pour identifier les JD appartenant aux services du ministère
path: /browsecat
doc: |
  Les objectifs sont:
    1) parcourir des catalogues pour notamment trouver et consulter les MD relevant du ministère (AC + SD),
    2) estimer l'intérêt d'un classement comme l'aborescence Covadis et/ou la liste des annexes Inspire
    3) prototyper un mécanisme de requête sur les métadonnées fondé sur l'utilisation de ces classements
  
  - harvest.php moissonne en CLI un catalogue, bufferise le résultat dans un répertoire et stocke les MD de D+S
    dans une table catalog${catid} dans PostgreSql.
  - gere.php exploite (en http) les moissons.
  - index.php sera une page publique de présentation.
  - ajouttheme.php exploite les regexps de arbocovadis.yaml pour ajouter des thèmes Covadis aux MDD
  - addarea.php ajoute un champ area aux tables catalog${catid}
  - crauxtabl.php crée 2 tables auxiliaires catorg${catid} et cattheme${catid} par catalogue indispensable
    pour générer une carte
  - map.php affiche une carte des MDD pour un thème Covadis et une organisation, il appelle geojson.php
  - geojson.php génère un flux GeoJSON pour un thème Covadis et une organisation pour la carte
    - utilise le champ area dans catalog${catid} et les tables auxiliaires catorg${catid} et cattheme${catid}
  
  Réutilisation des codes cswserver.inc.php, httpcache.inc.php et mdvars2.inc.php de geocat4
  Réutilisation de la bibiothèque d'utilisation de PgSql'
  Réutilisation de la classe Yaml de Symfony.
  
  Le résultat de cette analyse est le suivant:
    - GéoRisques contient peu de MD principalement de la DGPR
    - GpU contient des MD de SUP des DDT et DEAL mais aussi des docs d'urbanisme
    - Sextant contient quelques MD intéressantes du ministère, ex. Classement sanitaire des zones conchylicoles de Seine-Maritime
  
    - Geolittoral
    - CeremaData
    - EauFrance
    - Shom
    
  A priori ces MD ne proviennent pas de Géo-IDE.

  Les MD de Sextant peuvent être notamment de type 'publication' ou 'carte' ; ces MD ne peuvent pas être traduites
  en ISO 19115 ; elles sont alors stockées en DublinCore.
  
  Bases:
    host=pgsqlserver dbname=gis user=docker
    pgsql://benoit@db207552-001.dbaas.ovh.net:35250/catalog/public pour écrire
    pgsql://browsecat:Browsecat9@db207552-001.dbaas.ovh.net:35250/catalog/public pour lire
    
  Schéma:
    - une table catalog${catid} qui stocke les MDD+S du catalogue ${catid} 
    - 2 tables auxiliaires catorg${catid} et cattheme${catid} qui accélèrent la sélection des MDD pour un org et un thème
    
  Regarder les droits à donner à browsecat
  
  Voir dans themes.yaml les résultats sur les thésaurus.
  
  synchro par http://localhost/synchro.php?remote=http://bdavid.alwaysdata.net/&dir=browsecat
journal: |
  7-10/11/2021:
    - mise en oeuvre d'une carte sur la sélection org + theme
  4-6/11/2021:
    - élaboration d'un tableau de dénombrement par organisation et par thème
  3/11/2021:
    - Fin du moissonnage du géocatalogue (numberOfRecordsMatched=152115).
      - cela prend plus de 24 h de moissonnage
      - 131.483 MDD+S chargées dans PgSql dont 70.599 dans le périmètre
      - Beaucoup d'erreurs de moissonnage.
        - Beaucoup d'erreurs de GetRecords: renvoie une exception 'Resource not found'
        - Des erreurs de GetRecordById: 'Erreur: enregistrement ISO non défini'
      - beaucoup de MD des catalogues sont absentes du Géocatalogue
      - beaucoup plus de MD dans le géocaoalogue que dans l'agrégation des autres
  25/10-2/11/2021:
    - évolutions diverses, notamment durcissement du code pour moissonner le Géocatalogue
  18/10/2021:
    - améliorations
  11/10/2021:
    - création
phpScripts:
  - /browsecat/harvest.php
  - /browsecat/manage.php
  - /browsecat/ajouttheme.php
  - /browsecat/addarea.php
  - /browsecat/crauxtabl.php
  - /browsecat/manage.php
  - /browsecat/map.php
  - /browsecat/geojson.php
  - /browsecat/index.php
phpIncludes:
  - /browsecat/cats.inc.php
  - /browsecat/catinpgsql.inc.php
  - /browsecat/orginsel.inc.php
  #- /browsecat/annexes.inc.php
  - /browsecat/arbo.inc.php
  - /browsecat/tree.inc.php
  - /browsecat/mdvars2.inc.php
  - /browsecat/cswserver.inc.php
  - /browsecat/httpretry.inc.php
  - /browsecat/httpcache.inc.php
htmlFiles:
  - /browsecat/annexesinspire.yaml
  - /browsecat/arbocovadis.yaml
  - /browsecat/themes.yaml
